<script>
	import { io } from 'socket.io-client';
	import { spring } from 'svelte/motion';

	let loadingProgress = spring(0, {
		stiffness: 0.05
	});

	import { onMount, tick, setContext } from 'svelte';
	import {
		config,
		user,
		theme,
		WEBUI_NAME,
		mobile,
		socket,
		activeUserCount,
		USAGE_POOL,

		connectToNats

	} from '$lib/stores';
	import { goto } from '$app/navigation';
	import { page } from '$app/stores';
	import { Toaster, toast } from 'svelte-sonner';

	import { getBackendConfig } from '$lib/apis';
	import { getSessionUser } from '$lib/apis/auths';

	import '../tailwind.css';
	import '../app.css';

	import 'tippy.js/dist/tippy.css';

	import { WEBUI_BASE_URL, WEBUI_HOSTNAME } from '$lib/constants';
	import i18n, { initI18n, getLanguages } from '$lib/i18n';
	import { bestMatchingLanguage, getCookie } from '$lib/utils';
	import { getUserByToken } from '$lib/apis/triton';

	setContext('i18n', i18n);

	let loaded = false;
	const BREAKPOINT = 768;

	let wakeLock = null;

	onMount(async () => {
		theme.set(localStorage.theme);

		mobile.set(window.innerWidth < BREAKPOINT);
		const onResize = () => {
			if (window.innerWidth < BREAKPOINT) {
				mobile.set(true);
			} else {
				mobile.set(false);
			}
		};

		window.addEventListener('resize', onResize);

		const setWakeLock = async () => {
			try {
				wakeLock = await navigator.wakeLock.request('screen');
			} catch (err) {
				// The Wake Lock request has failed - usually system related, such as battery.
				console.log(err);
			}

			if (wakeLock) {
				// Add a listener to release the wake lock when the page is unloaded
				wakeLock.addEventListener('release', () => {
					// the wake lock has been released
					console.log('Wake Lock released');
				});
			}
		};

		if ('wakeLock' in navigator) {
			await setWakeLock();

			document.addEventListener('visibilitychange', async () => {
				// Re-request the wake lock if the document becomes visible
				if (wakeLock !== null && document.visibilityState === 'visible') {
					await setWakeLock();
				}
			});
		}

		let backendConfig = null;
		try {
			backendConfig = {
				status: true,
				name: 'Sia : Tech Support AI Agent',
				version: '0.3.7',
				default_locale: 'en-US',
				default_models: null,
				default_prompt_suggestions: [
					{
						title: ['General', 'What all things can you help me with ?'],
						content: 'What all things can you help me with ?'
					},
					{
						title: ['Performance', 'My PC is running slow, can you help ?'],
						content: 'My PC is running slow, can you help ?'
					},
					{
						title: ['Setup', 'How to set up my work email on my iPhone ?'],
						content: 'How to set up my work email on my iPhone ?'
					},
					{
						title: [
							'Troubleshooting',
							'The webcam of my Lenovo Ideapad Slim3 is not working properly, need help ?'
						],
						content: 'The webcam of my Lenovo Ideapad Slim3 is not working properly, need help ?'
					},
					{
						title: [
							'Recommendation',
							'My laptop battery drains quickly, how can I improve battery life ?'
						],
						content: 'My laptop battery drains quickly, how can I improve battery life ?'
					},
					{
						title: ['Help', 'How can i recover deleted files from my windows 10 machine ?'],
						content: 'How can i recover deleted files from my windows 10 machine ?'
					},
					{
						title: [
							'Comparison',
							'I am looking for high speed internet plan, compare Airtel Xtreme Fibore and Jio Fibre plans for me ?'
						],
						content:
							'I am looking for high speed internet plan, compare Airtel Xtreme Fibore and Jio Fibre plans for me ?'
					}
				],
				features: {
					auth: true,
					auth_trusted_header: false,
					enable_signup: true,
					enable_web_search: false,
					enable_image_generation: false,
					enable_community_sharing: false,
					enable_admin_export: true
				},
				audio: {
					tts: {
						engine: '',
						voice: 'alloy'
					},
					stt: {
						engine: ''
					}
				},
				oauth: {
					providers: {}
				}
			};
			console.log('Backend config:', backendConfig);
		} catch (error) {
			console.error('Error loading backend config:', error);
		}
		// Initialize i18n even if we didn't get a backend config,
		// so `/error` can show something that's not `undefined`.

		initI18n();
		if (!localStorage.locale) {
			const languages = await getLanguages();
			const browserLanguages = navigator.languages
				? navigator.languages
				: [navigator.language || navigator.userLanguage];
			const lang = backendConfig.default_locale
				? backendConfig.default_locale
				: bestMatchingLanguage(languages, browserLanguages, 'en-US');
			$i18n.changeLanguage(lang);
		}

		if (backendConfig) {
			// Save Backend Status to Store
			await config.set(backendConfig);
			await WEBUI_NAME.set(backendConfig.name);

			if ($config) {
				// const _socket = io(`${WEBUI_BASE_URL}`, {
				// 	path: '/ws/socket.io',
				// 	auth: { token: localStorage.token }
				// });

				// _socket.on('connect', () => {
				// 	console.log('connected');
				// });

				// await socket.set(_socket);

				// _socket.on('user-count', (data) => {
				// 	console.log('user-count', data);
				// 	activeUserCount.set(data.count);
				// });

				// _socket.on('usage', (data) => {
				// 	console.log('usage', data);
				// 	USAGE_POOL.set(data['models']);
				// });

				const access_token = getCookie('access_token');

				if (access_token) {
					// if(localstorage.token){
					// Get Session User Info
					// const sessionUser = await getSessionUser(localStorage.token).catch((error) => {
					// 	toast.error(error);
					// 	return null;
					// });

					const sessionUser = await getUserByToken(access_token).catch((error) => {
						toast.error(error);
						return null;
					});

					if (sessionUser) {
						// Save Session User to Store
						if(sessionUser.status === "PROFILE_PENDING"){
							await goto('/auth/onboarding');
						}
						await user.set(sessionUser);
						await connectToNats(access_token);
					} else {
						// Redirect Invalid Session User to /auth Page
						localStorage.removeItem('token');
						console.log($page.url);
						await goto('/auth');
					}
				} else {
					// Don't redirect if we're already on the auth page
					// Needed because we pass in tokens from OAuth logins via URL fragments
					if (!$page.url.pathname.startsWith('/auth') && !$page.url.pathname.startsWith('/home')) {
						console.log($page.url);
						await goto('/home');
					}
				}
			}
		} else {
			// Redirect to /error when Backend Not Detected
			await goto(`/error`);
		}

		await tick();

		if (
			document.documentElement.classList.contains('her') &&
			document.getElementById('progress-bar')
		) {
			loadingProgress.subscribe((value) => {
				const progressBar = document.getElementById('progress-bar');

				if (progressBar) {
					progressBar.style.width = `${value}%`;
				}
			});

			await loadingProgress.set(100);

			document.getElementById('splash-screen')?.remove();

			const audio = new Audio(`/audio/greeting.mp3`);
			const playAudio = () => {
				audio.play();
				document.removeEventListener('click', playAudio);
			};

			document.addEventListener('click', playAudio);

			loaded = true;
		} else {
			document.getElementById('splash-screen')?.remove();
			loaded = true;
		}
		return () => {
			window.removeEventListener('resize', onResize);
		};
	});
</script>

<svelte:head>
	<title>{$WEBUI_NAME}</title>
	<link crossorigin="anonymous" rel="icon" href="{WEBUI_BASE_URL}/static/favicon.png" />

	<!-- rosepine themes have been disabled as it's not up to date with our latest version. -->
	<!-- feel free to make a PR to fix if anyone wants to see it return -->
	<!-- <link rel="stylesheet" type="text/css" href="/themes/rosepine.css" />
	<link rel="stylesheet" type="text/css" href="/themes/rosepine-dawn.css" /> -->
</svelte:head>

{#if loaded}
	<slot />
{/if}

<Toaster richColors position="top-center" />
