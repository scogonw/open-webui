<script>
	import { goto } from '$app/navigation';
	import { getSessionUser, userSignIn, userSignUp } from '$lib/apis/auths';
	import Spinner from '$lib/components/common/Spinner.svelte';
	import { WEBUI_API_BASE_URL, WEBUI_BASE_URL } from '$lib/constants';
	import { WEBUI_NAME, config, user, socket } from '$lib/stores';
	import { onMount, getContext } from 'svelte';
	import { toast } from 'svelte-sonner';
	import { generateInitialsImage, canvasPixelTest } from '$lib/utils';
	import { page } from '$app/stores';
	import crypto from 'crypto';

	const i18n = getContext('i18n');

	let loaded = false;
	let mode = 'signin';
	const params = new URLSearchParams($page.url.search);
	const signup = params.get('signup');
	if(signup){
		mode = 'signup'
	}


	let firstName = '';
	let lastName = '';
	let email = params.get('email') || '';
	let mobile = null;
	let password = '';
	let loading = false;
	let inviteId = params.get('inviteId') || '';

	const ZITADEL_BASE_URL = import.meta.env.VITE_ZITADEL_DOMAIN;
	const ZITADEL_SERVICE_ACCESS_TOKEN = import.meta.env.VITE_ZITADEL_SERVICE_ACCESS_TOKEN;
	const REDIRECT_URI = import.meta.env.VITE_REDIRECT_URI;

	const setSessionUser = async (sessionUser) => {
		if (sessionUser) {
			console.log(sessionUser);
			toast.success($i18n.t(`You're now logged in.`));
			if (sessionUser.token) {
				localStorage.token = sessionUser.token;
			}

			$socket.emit('user-join', { auth: { token: sessionUser.token } });
			await user.set(sessionUser);
			goto('/');
		}
	};

	const createCallback = async ({ authRequestId, session }) => {
		try {
			let body = {
				session: {
					sessionId: session.sessionId,
					sessionToken: session.sessionToken
				}
			};
			body = JSON.parse(JSON.stringify(body));
			const url = new URL(`${ZITADEL_BASE_URL}/v2beta/oidc/auth_requests/${authRequestId}`);
			console.log(url);
			const headers = new Headers();
			headers.append('Content-Type', 'application/json');
			headers.append('Authorization', `Bearer ${ZITADEL_SERVICE_ACCESS_TOKEN}`);
			const response = await fetch(url, {
				method: 'POST',
				body: JSON.stringify(body),
				headers: headers
			});
			console.log(response);
			return {
				status: response.status,
				data: await response.json()
			};
		} catch (error) {
			console.log(error);
		}
	};

	const signInHandler = async () => {
		// const sessionUser = await userSignIn(email, password).catch((error) => {
		// 	toast.error(error);
		// 	return null;
		// });

		// await setSessionUser(sessionUser);

		loading = true;
		try {
			const signInresponse = await fetch('/api/createSession', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					email,
					password
				})
			});

			if (signInresponse.ok) {
				const signInJSON = await signInresponse.json();
				console.log(signInJSON);
				const { session_id, session_token } = signInJSON;
				const params = new URLSearchParams($page.url.search);
				const authRequestId = params.get('authRequestId');
				const callbackresponse = await createCallback({
					authRequestId: authRequestId,
					session: { sessionId: session_id, sessionToken: session_token }
				});
				console.log(callbackresponse);
				if (
					callbackresponse?.status === 200 &&
					callbackresponse?.data &&
					callbackresponse?.data?.callbackUrl
				) {
					const { searchParams } = new URL(callbackresponse?.data?.callbackUrl);
					const code = searchParams.get('code');
				}
				const callback = new URL(callbackresponse?.data?.callbackUrl);
				callback.searchParams.append('redirect_uri', REDIRECT_URI);
				console.log(callback);
				goto(callback.href);
			} else {
				const {data} = await signInresponse.json();
				toast.error(`Error : ${data?.message[0]}`);
			}
		} catch (error) {
			console.log(error);
		}
		loading = false;
	};

	const signUpHandler = async () => {
		// const sessionUser = await userSignUp(
		// 	firstName,
		// 	email,
		// 	password,
		// 	generateInitialsImage(firstName)
		// ).catch((error) => {
		// 	toast.error(error);
		// 	return null;
		// });

		// await setSessionUser(sessionUser);
		loading = true;
		try {
			const signUpResponse = await fetch('/api/signup', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					inviteId,
					firstName,
					lastName,
					mobile,
					email,
					password
				})
			});

			console.log(signUpResponse);
			if (signUpResponse.ok) {
				const sessionData = await signUpResponse.json();
				console.log(sessionData);
				const params = new URLSearchParams($page.url.search);
				const authRequestId = params.get('authRequestId');
				const callbackresponse = await createCallback({
					authRequestId: authRequestId,
					session: { sessionId: sessionData.session_id, sessionToken: sessionData.session_token }
				});
				console.log(callbackresponse);
				if (
					callbackresponse?.status === 200 &&
					callbackresponse?.data &&
					callbackresponse?.data?.callbackUrl
				) {
					const { searchParams } = new URL(callbackresponse?.data?.callbackUrl);
					const code = searchParams.get('code');
				}
				const callback = new URL(callbackresponse?.data?.callbackUrl);
				callback.searchParams.append('redirect_uri', REDIRECT_URI);
				console.log(callback);
				goto(callback.href);
			}
			else{
				const {data} = await signUpResponse.json();
				toast.error(`Error : ${data?.message[0]}`);
			}
		} catch (error) {
			console.log(error);
		}
		loading = false;
	};

	const submitHandler = async () => {
		if (mode === 'signin') {
			await signInHandler();
		} else {
			await signUpHandler();
		}
	};

	const checkOauthCallback = async () => {
		if (!$page.url.hash) {
			return;
		}
		const hash = $page.url.hash.substring(1);
		if (!hash) {
			return;
		}
		const params = new URLSearchParams(hash);
		const token = params.get('token');
		if (!token) {
			return;
		}
		const sessionUser = await getSessionUser(token).catch((error) => {
			toast.error(error);
			return null;
		});
		if (!sessionUser) {
			return;
		}
		localStorage.token = token;
		await setSessionUser(sessionUser);
	};

	onMount(async () => {
		if ($user !== undefined) {
			await goto('/');
		}
		loaded = true;
		if (($config?.features.auth_trusted_header ?? false) || $config?.features.auth === false) {
			await signInHandler();
		}
		const params = new URLSearchParams($page.url.search);
		let authRequestId = params.get('authRequestId');
		if (!authRequestId) {
			const res = await fetch('/api/authRequestId', { method: 'GET' });
			const resJson = await res.json();
			console.log(resJson);
			if (resJson?.verifier) {
				localStorage.setItem('verifier', resJson?.verifier);
			}
			if (resJson?.authRequestId) {
				authRequestId = resJson?.authRequestId;
				params.set('authRequestId', authRequestId);
				const newUrl = `${$page.url.pathname}?${params.toString()}`;
				goto(newUrl);
			}
		}
	});
</script>

<svelte:head>
	<title>
		{`${$WEBUI_NAME}`}
	</title>
</svelte:head>

{#if loaded}
	<div class="fixed m-10 z-50">
		<div class="flex space-x-2">
			<div class=" self-center">
				<img
					crossorigin="anonymous"
					src="/logo.png"
					class=" w-8 rounded-full"
					alt="logo"
				/>
			</div>
		</div>
	</div>

	<div class=" bg-white dark:bg-gray-950 min-h-screen w-full flex justify-center">
		<div class="w-full sm:max-w-md px-10 min-h-screen flex flex-col text-center">
			{#if ($config?.features.auth_trusted_header ?? false) || $config?.features.auth === false}
				<div class=" my-auto pb-10 w-full">
					<div
						class="flex items-center justify-center gap-3 text-xl sm:text-2xl text-center font-medium dark:text-gray-200"
					>
						<div>
							{$i18n.t('Signing in')}
							{$i18n.t('to')}
							{$WEBUI_NAME}
						</div>

						<div>
							<Spinner />
						</div>
					</div>
				</div>
			{:else}
				<div class="  my-auto pb-10 w-full dark:text-gray-100">
					<form
						class=" flex flex-col justify-center"
						on:submit|preventDefault={() => {
							submitHandler();
						}}
					>
						<div class="mb-1">
							<div class=" text-2xl font-medium">
								{mode === 'signin' ? $i18n.t('Sign in') : $i18n.t('Sign up')}
								{$i18n.t('to')}
								{$WEBUI_NAME}
							</div>

							{#if mode === 'signup'}
								<div class=" mt-1 text-xs font-medium text-gray-500">
									â“˜ {$WEBUI_NAME}
									{$i18n.t(
										'does not make any external connections, and your data stays securely on your locally hosted server.'
									)}
								</div>
							{/if}
						</div>

						<div class="flex flex-col mt-4">
							{#if mode === 'signup'}
								<div>
									<div class=" text-sm font-medium text-left mb-1">{$i18n.t('First Name')}</div>
									<input
										bind:value={firstName}
										type="text"
										class=" px-5 py-3 rounded-2xl w-full text-sm outline-none border dark:border-none dark:bg-gray-900"
										autocomplete="name"
										placeholder={$i18n.t('Enter Your First Name')}
										required
									/>
									<div class=" text-sm font-medium text-left mb-1 mt-2">{$i18n.t('Last Name')}</div>
									<input
										bind:value={lastName}
										type="text"
										class=" px-5 py-3 rounded-2xl w-full text-sm outline-none border dark:border-none dark:bg-gray-900"
										autocomplete="name"
										placeholder={$i18n.t('Enter Your First Name')}
										required
									/>
									<div class=" text-sm font-medium text-left mt-2">{$i18n.t('Phone Number')}</div>
									<input
										bind:value={mobile}
										type="number"
										class=" px-5 py-3 rounded-2xl w-full text-sm outline-none border dark:border-none dark:bg-gray-900"
										autocomplete="tel"
										placeholder={$i18n.t('Enter Your Phone Number')}
									/>
								</div>

								<hr class=" my-3 dark:border-gray-900" />
							{/if}

							<div class="mb-2">
								<div class=" text-sm font-medium text-left mb-1">{$i18n.t('Email')}</div>
								<input
									bind:value={email}
									type="email"
									class=" px-5 py-3 rounded-2xl w-full text-sm outline-none border dark:border-none dark:bg-gray-900"
									autocomplete="email"
									placeholder={$i18n.t('Enter Your Email')}
									required
								/>
							</div>

							<div>
								<div class=" text-sm font-medium text-left mb-1">{$i18n.t('Password')}</div>

								<input
									bind:value={password}
									type="password"
									class=" px-5 py-3 rounded-2xl w-full text-sm outline-none border dark:border-none dark:bg-gray-900"
									placeholder={$i18n.t('Enter Your Password')}
									autocomplete="current-password"
									required
								/>
							</div>
							{#if mode === 'signin'}
								<a href="/auth/forgot" class="text-left w-full mt-2">Forgot Password ?</a>
							{/if}
						</div>

						<div class="mt-3">
							<button
								class=" bg-gray-900 hover:bg-gray-800 w-full rounded-2xl text-white font-medium text-sm py-3 transition disabled:bg-gray-700"
								type="submit"
								disabled={loading}
							>
								{#if loading}
									<Spinner />
								{:else}
									{mode === 'signin' ? $i18n.t('Sign in') : $i18n.t('Create Account')}
								{/if}
							</button>

							{#if $config?.features.enable_signup}
								<div class=" mt-4 text-sm text-center">
									{mode === 'signin'
										? $i18n.t("Don't have an account?")
										: $i18n.t('Already have an account?')}

									<button
										class=" font-medium underline"
										type="button"
										on:click={() => {
											if (mode === 'signin') {
												mode = 'signup';
											} else {
												mode = 'signin';
											}
										}}
									>
										{mode === 'signin' ? $i18n.t('Sign up') : $i18n.t('Sign in')}
									</button>
								</div>
							{/if}
						</div>
					</form>

					{#if Object.keys($config?.oauth?.providers ?? {}).length > 0}
						<div class="inline-flex items-center justify-center w-full">
							<hr class="w-64 h-px my-8 bg-gray-200 border-0 dark:bg-gray-700" />
							<span
								class="absolute px-3 font-medium text-gray-900 -translate-x-1/2 bg-white left-1/2 dark:text-white dark:bg-gray-950"
								>{$i18n.t('or')}</span
							>
						</div>
						<div class="flex flex-col space-y-2">
							{#if $config?.oauth?.providers?.google}
								<button
									class="flex items-center px-6 border-2 dark:border-gray-800 duration-300 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 w-full rounded-2xl dark:text-white text-sm py-3 transition"
									on:click={() => {
										window.location.href = `${WEBUI_BASE_URL}/oauth/google/login`;
									}}
								>
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="size-6 mr-3">
										<path
											fill="#EA4335"
											d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"
										/><path
											fill="#4285F4"
											d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"
										/><path
											fill="#FBBC05"
											d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"
										/><path
											fill="#34A853"
											d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"
										/><path fill="none" d="M0 0h48v48H0z" />
									</svg>
									<span>{$i18n.t('Continue with {{provider}}', { provider: 'Google' })}</span>
								</button>
							{/if}
							{#if $config?.oauth?.providers?.microsoft}
								<button
									class="flex items-center px-6 border-2 dark:border-gray-800 duration-300 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 w-full rounded-2xl dark:text-white text-sm py-3 transition"
									on:click={() => {
										window.location.href = `${WEBUI_BASE_URL}/oauth/microsoft/login`;
									}}
								>
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21 21" class="size-6 mr-3">
										<rect x="1" y="1" width="9" height="9" fill="#f25022" /><rect
											x="1"
											y="11"
											width="9"
											height="9"
											fill="#00a4ef"
										/><rect x="11" y="1" width="9" height="9" fill="#7fba00" /><rect
											x="11"
											y="11"
											width="9"
											height="9"
											fill="#ffb900"
										/>
									</svg>
									<span>{$i18n.t('Continue with {{provider}}', { provider: 'Microsoft' })}</span>
								</button>
							{/if}
							{#if $config?.oauth?.providers?.oidc}
								<button
									class="flex items-center px-6 border-2 dark:border-gray-800 duration-300 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-800 w-full rounded-2xl dark:text-white text-sm py-3 transition"
									on:click={() => {
										window.location.href = `${WEBUI_BASE_URL}/oauth/oidc/login`;
									}}
								>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										fill="none"
										viewBox="0 0 24 24"
										stroke-width="1.5"
										stroke="currentColor"
										class="size-6 mr-3"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1 1 21.75 8.25Z"
										/>
									</svg>

									<span
										>{$i18n.t('Continue with {{provider}}', {
											provider: $config?.oauth?.providers?.oidc ?? 'SSO'
										})}</span
									>
								</button>
							{/if}
						</div>
					{/if}
				</div>
			{/if}
		</div>
	</div>
{/if}

<style>
	.font-mona {
		font-family: 'Mona Sans', -apple-system, 'Arimo', ui-sans-serif, system-ui, 'Segoe UI', Roboto,
			Ubuntu, Cantarell, 'Noto Sans', sans-serif, 'Helvetica Neue', Arial, 'Apple Color Emoji',
			'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
	}
</style>
